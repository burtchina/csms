{% extends 'base.html' %}
{% block title %}实时监控{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">实时监控</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">仪表盘</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('performance.index') }}">性能监控</a></li>
        <li class="breadcrumb-item active">实时监控</li>
    </ol>
    
    <!-- 设备选择和控制 -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-server me-1"></i>
                        设备实时监控
                    </div>
                    <div>
                        <span id="connection-status" class="badge bg-secondary me-2">未连接</span>
                        <span id="last-updated" class="text-muted me-2">最后更新: --</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="device-select">选择设备</label>
                                <select class="form-select" id="device-select">
                                    <option value="">-- 请选择设备 --</option>
                                    {% for device in devices %}
                                    <option value="{{ device.id }}">{{ device.name }} ({{ device.ip_address }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="btn-group">
                                <button type="button" id="start-monitor-btn" class="btn btn-success" disabled>
                                    <i class="fas fa-play me-1"></i>启动监控
                                </button>
                                <button type="button" id="stop-monitor-btn" class="btn btn-danger" disabled>
                                    <i class="fas fa-stop me-1"></i>停止监控
                                </button>
                                <button type="button" id="refresh-btn" class="btn btn-primary" disabled>
                                    <i class="fas fa-sync-alt me-1"></i>刷新数据
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="device-info" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>设备: </strong><span id="device-name"></span>
                                    <strong class="ms-3">IP: </strong><span id="device-ip"></span>
                                </div>
                                <div>
                                    <strong>运行时间: </strong><span id="device-uptime">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 性能仪表盘 -->
    <div class="row" id="performance-dashboard" style="display: none;">
        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-microchip me-1"></i>
                    CPU使用率
                </div>
                <div class="card-body text-center">
                    <div id="cpu-gauge" style="height: 200px;"></div>
                    <div class="mt-3">
                        <span class="h4" id="cpu-value">0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-memory me-1"></i>
                    内存使用率
                </div>
                <div class="card-body text-center">
                    <div id="memory-gauge" style="height: 200px;"></div>
                    <div class="mt-3">
                        <span class="h4" id="memory-value">0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-network-wired me-1"></i>
                    带宽使用率
                </div>
                <div class="card-body text-center">
                    <div id="bandwidth-gauge" style="height: 200px;"></div>
                    <div class="mt-3">
                        <span class="h4" id="bandwidth-value">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 实时图表 -->
    <div class="row" id="realtime-charts" style="display: none;">
        <div class="col-lg-12">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-1"></i>
                    实时性能数据
                </div>
                <div class="card-body">
                    <canvas id="realtime-chart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 接口状态 -->
    <div class="row" id="interfaces-section" style="display: none;">
        <div class="col-lg-12">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-ethernet me-1"></i>
                    接口状态
                </div>
                <div class="card-body">
                    <div id="interfaces-container">
                        <div class="alert alert-info">正在加载接口数据...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
<script>
    // 全局变量
    var selectedDevice = null;
    var monitoring = false;
    var realtimeChart = null;
    var cpuGauge = null;
    var memoryGauge = null;
    var bandwidthGauge = null;
    var dataHistory = {
        timestamps: [],
        cpu: [],
        memory: [],
        bandwidth: []
    };
    var refreshInterval = null;
    
    $(document).ready(function() {
        // 初始化ECharts仪表盘
        initGauges();
        
        // 设备选择变更
        $('#device-select').change(function() {
            var deviceId = $(this).val();
            if (deviceId) {
                selectedDevice = deviceId;
                $('#start-monitor-btn').prop('disabled', false);
                $('#device-info').show();
                
                // 获取设备信息
                updateDeviceInfo();
            } else {
                selectedDevice = null;
                $('#start-monitor-btn').prop('disabled', true);
                $('#stop-monitor-btn').prop('disabled', true);
                $('#refresh-btn').prop('disabled', true);
                $('#device-info').hide();
                $('#performance-dashboard').hide();
                $('#realtime-charts').hide();
                $('#interfaces-section').hide();
                stopMonitoring();
            }
        });
        
        // 启动监控按钮
        $('#start-monitor-btn').click(function() {
            if (!selectedDevice) return;
            
            $.ajax({
                url: '/performance/realtime/start/' + selectedDevice,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        startMonitoring();
                        showAlert('success', response.message);
                    } else {
                        showAlert('danger', response.message);
                    }
                },
                error: function() {
                    showAlert('danger', '请求失败，无法启动监控');
                }
            });
        });
        
        // 停止监控按钮
        $('#stop-monitor-btn').click(function() {
            if (!selectedDevice || !monitoring) return;
            
            $.ajax({
                url: '/performance/realtime/stop/' + selectedDevice,
                type: 'POST',
                success: function(response) {
                    if (response.status === 'success') {
                        stopMonitoring();
                        showAlert('success', response.message);
                    } else {
                        showAlert('danger', response.message);
                    }
                },
                error: function() {
                    showAlert('danger', '请求失败，无法停止监控');
                }
            });
        });
        
        // 刷新数据按钮
        $('#refresh-btn').click(function() {
            if (!selectedDevice) return;
            fetchData();
        });
        
        // 初始化实时图表
        function initRealtimeChart() {
            var ctx = document.getElementById('realtime-chart').getContext('2d');
            
            if (realtimeChart) {
                realtimeChart.destroy();
            }
            
            realtimeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU (%)',
                            data: [],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '内存 (%)',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '带宽 (%)',
                            data: [],
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '使用率 (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    animation: {
                        duration: 500
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        // 初始化仪表盘
        function initGauges() {
            // CPU仪表盘
            cpuGauge = echarts.init(document.getElementById('cpu-gauge'));
            var cpuOption = createGaugeOption('CPU', 0, 'rgb(75, 192, 192)');
            cpuGauge.setOption(cpuOption);
            
            // 内存仪表盘
            memoryGauge = echarts.init(document.getElementById('memory-gauge'));
            var memoryOption = createGaugeOption('内存', 0, 'rgb(54, 162, 235)');
            memoryGauge.setOption(memoryOption);
            
            // 带宽仪表盘
            bandwidthGauge = echarts.init(document.getElementById('bandwidth-gauge'));
            var bandwidthOption = createGaugeOption('带宽', 0, 'rgb(255, 206, 86)');
            bandwidthGauge.setOption(bandwidthOption);
            
            // 窗口大小变化时重新调整图表大小
            window.addEventListener('resize', function() {
                if (cpuGauge) cpuGauge.resize();
                if (memoryGauge) memoryGauge.resize();
                if (bandwidthGauge) bandwidthGauge.resize();
                if (realtimeChart) realtimeChart.resize();
            });
        }
        
        // 创建仪表盘配置
        function createGaugeOption(name, value, color) {
            return {
                series: [{
                    type: 'gauge',
                    min: 0,
                    max: 100,
                    splitNumber: 10,
                    radius: '100%',
                    axisLine: {
                        lineStyle: {
                            width: 10,
                            color: [
                                [0.3, 'rgba(0, 205, 0, 0.8)'],
                                [0.7, 'rgba(255, 165, 0, 0.8)'],
                                [1, 'rgba(255, 0, 0, 0.8)']
                            ]
                        }
                    },
                    pointer: {
                        itemStyle: {
                            color: color
                        }
                    },
                    axisTick: {
                        distance: -10,
                        length: 8,
                        lineStyle: {
                            color: '#fff',
                            width: 2
                        }
                    },
                    splitLine: {
                        distance: -10,
                        length: 15,
                        lineStyle: {
                            color: '#fff',
                            width: 3
                        }
                    },
                    axisLabel: {
                        distance: 15,
                        color: '#999',
                        fontSize: 10
                    },
                    detail: {
                        valueAnimation: true,
                        formatter: '{value}%',
                        color: 'inherit',
                        fontSize: 16
                    },
                    data: [{
                        value: value,
                        name: name
                    }]
                }]
            };
        }
        
        // 更新设备信息
        function updateDeviceInfo() {
            var deviceSelect = document.getElementById('device-select');
            var selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            var deviceName = selectedOption.text;
            
            $('#device-name').text(deviceName);
            $('#device-ip').text(deviceName.match(/\((.*?)\)/)[1]);
        }
        
        // 开始监控
        function startMonitoring() {
            monitoring = true;
            $('#connection-status').removeClass('bg-secondary bg-danger').addClass('bg-success').text('已连接');
            $('#start-monitor-btn').prop('disabled', true);
            $('#stop-monitor-btn').prop('disabled', false);
            $('#refresh-btn').prop('disabled', false);
            
            // 显示面板
            $('#performance-dashboard').show();
            $('#realtime-charts').show();
            $('#interfaces-section').show();
            
            // 初始化图表
            initRealtimeChart();
            
            // 清空历史数据
            dataHistory = {
                timestamps: [],
                cpu: [],
                memory: [],
                bandwidth: []
            };
            
            // 立即获取一次数据
            fetchData();
            
            // 设置定时刷新
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(fetchData, 5000); // 每5秒刷新一次
        }
        
        // 停止监控
        function stopMonitoring() {
            monitoring = false;
            $('#connection-status').removeClass('bg-success bg-danger').addClass('bg-secondary').text('未连接');
            $('#start-monitor-btn').prop('disabled', false);
            $('#stop-monitor-btn').prop('disabled', true);
            
            // 清除定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // 获取实时数据
        function fetchData() {
            if (!selectedDevice) return;
            
            $.ajax({
                url: '/performance/realtime/data/' + selectedDevice,
                type: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        updateDashboard(response.data);
                    } else {
                        $('#connection-status').removeClass('bg-success bg-secondary').addClass('bg-danger').text('连接错误');
                        console.error('Error fetching data:', response.message);
                    }
                },
                error: function() {
                    $('#connection-status').removeClass('bg-success bg-secondary').addClass('bg-danger').text('连接错误');
                    console.error('Failed to fetch data');
                }
            });
        }
        
        // 更新仪表盘
        function updateDashboard(data) {
            // 更新最后更新时间
            var now = new Date();
            $('#last-updated').text('最后更新: ' + now.toLocaleTimeString());
            
            // 更新运行时间
            $('#device-uptime').text(data.uptime || '--');
            
            // 更新CPU、内存、带宽使用率
            var cpuUsage = data.cpu_usage;
            var memoryUsage = data.memory_usage;
            var bandwidthUsage = data.bandwidth_usage;
            
            // 更新仪表盘
            cpuGauge.setOption({
                series: [{
                    data: [{
                        value: cpuUsage
                    }]
                }]
            });
            
            memoryGauge.setOption({
                series: [{
                    data: [{
                        value: memoryUsage
                    }]
                }]
            });
            
            bandwidthGauge.setOption({
                series: [{
                    data: [{
                        value: bandwidthUsage
                    }]
                }]
            });
            
            // 更新数值显示
            $('#cpu-value').text(cpuUsage.toFixed(1) + '%');
            $('#memory-value').text(memoryUsage.toFixed(1) + '%');
            $('#bandwidth-value').text(bandwidthUsage.toFixed(1) + '%');
            
            // 更新历史数据
            var timestamp = new Date().toLocaleTimeString();
            dataHistory.timestamps.push(timestamp);
            dataHistory.cpu.push(cpuUsage);
            dataHistory.memory.push(memoryUsage);
            dataHistory.bandwidth.push(bandwidthUsage);
            
            // 保持最近20个数据点
            if (dataHistory.timestamps.length > 20) {
                dataHistory.timestamps.shift();
                dataHistory.cpu.shift();
                dataHistory.memory.shift();
                dataHistory.bandwidth.shift();
            }
            
            // 更新图表
            if (realtimeChart) {
                realtimeChart.data.labels = dataHistory.timestamps;
                realtimeChart.data.datasets[0].data = dataHistory.cpu;
                realtimeChart.data.datasets[1].data = dataHistory.memory;
                realtimeChart.data.datasets[2].data = dataHistory.bandwidth;
                realtimeChart.update();
            }
            
            // 更新接口信息
            updateInterfaces(data.interfaces);
        }
        
        // 更新接口信息
        function updateInterfaces(interfaces) {
            var container = $('#interfaces-container');
            container.empty();
            
            if (!interfaces || Object.keys(interfaces).length === 0) {
                container.html('<div class="alert alert-warning">无接口数据</div>');
                return;
            }
            
            var table = $('<table class="table table-striped table-hover">');
            var thead = $('<thead>').appendTo(table);
            var tbody = $('<tbody>').appendTo(table);
            
            // 表头
            $('<tr>').append(
                $('<th>').text('接口名称'),
                $('<th>').text('状态'),
                $('<th>').text('输入速率'),
                $('<th>').text('输出速率')
            ).appendTo(thead);
            
            // 表内容
            $.each(interfaces, function(name, info) {
                var statusClass = info.status === 'up' ? 'text-success' : 'text-danger';
                var statusIcon = info.status === 'up' ? 'fa-check-circle' : 'fa-times-circle';
                
                var inputRate = formatBitRate(info.input_rate || 0);
                var outputRate = formatBitRate(info.output_rate || 0);
                
                $('<tr>').append(
                    $('<td>').text(name),
                    $('<td>').html('<i class="fas ' + statusIcon + ' ' + statusClass + '"></i> ' + info.status),
                    $('<td>').text(inputRate),
                    $('<td>').text(outputRate)
                ).appendTo(tbody);
            });
            
            container.append(table);
        }
        
        // 格式化比特率
        function formatBitRate(bits) {
            if (bits < 1000) return bits + ' bit/s';
            if (bits < 1000000) return (bits / 1000).toFixed(2) + ' Kbit/s';
            if (bits < 1000000000) return (bits / 1000000).toFixed(2) + ' Mbit/s';
            return (bits / 1000000000).toFixed(2) + ' Gbit/s';
        }
        
        // 显示提示信息
        function showAlert(type, message) {
            var alertDiv = $('<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">')
                .text(message)
                .append('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>')
                .appendTo('#device-info');
                
            // 5秒后自动关闭
            setTimeout(function() {
                alertDiv.alert('close');
            }, 5000);
        }
    });
</script>
{% endblock %} 